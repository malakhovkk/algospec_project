# Конфигурация Nginx для AlgoSpec проекта
# Скопируйте этот файл на VPS: /etc/nginx/sites-available/algospec
# Затем активируйте: sudo ln -s /etc/nginx/sites-available/algospec /etc/nginx/sites-enabled/

# ============================================
# ВАРИАНТ 1: Для домена с HTTPS
# ============================================
# Раскомментируйте этот блок, если у вас есть домен и SSL сертификат
# Замените your-domain.com на ваш домен

# server {
#     listen 80;
#     listen 443 ssl;
#     server_name your-domain.com www.your-domain.com;
# 
#     # SSL сертификат (раскомментируйте, если используете SSL)
#     ssl_certificate /etc/nginx/ssl/certificate.crt;
#     ssl_certificate_key /etc/nginx/ssl/certificate.key;
#     
#     # SSL настройки безопасности
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
#     ssl_prefer_server_ciphers off;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
# 
#     # Редирект с HTTP на HTTPS (раскомментируйте, если используете SSL)
#     if ($scheme != "https") {
#         return 301 https://$host$request_uri;
#     }
# 
#     # Проксирование на Next.js фронтенд (порт 3000)
#     location / {
#         proxy_pass http://localhost:3000;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#         
#         # Таймауты
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#     }
# 
#     # Проксирование API на NestJS бэкенд (порт 3001)
#     location /api {
#         proxy_pass http://localhost:3001;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#         
#         # CORS заголовки (если нужно)
#         add_header 'Access-Control-Allow-Origin' '*' always;
#         add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
#         add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
#         
#         # Обработка preflight запросов
#         if ($request_method = 'OPTIONS') {
#             add_header 'Access-Control-Allow-Origin' '*';
#             add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH';
#             add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With';
#             add_header 'Access-Control-Max-Age' 1728000;
#             add_header 'Content-Type' 'text/plain; charset=utf-8';
#             add_header 'Content-Length' 0;
#             return 204;
#         }
#         
#         # Таймауты
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#     }
# 
#     # Логирование
#     access_log /var/log/nginx/algospec_access.log;
#     error_log /var/log/nginx/algospec_error.log;
# }

# ============================================
# ВАРИАНТ 2: Для IP адреса (без домена)
# ============================================
# Раскомментируйте этот блок, если используете IP адрес
# Замените _ на конкретный IP или оставьте _ для любого IP

server {
    listen 80;
    server_name _;  # _ означает "любой домен/IP"
    # или укажите конкретный IP: server_name 123.45.67.89;

    # Проксирование на Next.js фронтенд (порт 3000)
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Проксирование API на NestJS бэкенд (порт 3001)
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # CORS заголовки
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
        
        # Обработка preflight запросов
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH';
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        
        # Таймауты
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Логирование
    access_log /var/log/nginx/algospec_access.log;
    error_log /var/log/nginx/algospec_error.log;
}

# ============================================
# ИНСТРУКЦИЯ ПО УСТАНОВКЕ:
# ============================================
# 1. Скопируйте этот файл на VPS:
#    sudo cp nginx.conf /etc/nginx/sites-available/algospec
#
# 2. Отредактируйте файл (замените your-domain.com или настройте IP):
#    sudo nano /etc/nginx/sites-available/algospec
#
# 3. Активируйте конфигурацию:
#    sudo ln -s /etc/nginx/sites-available/algospec /etc/nginx/sites-enabled/
#
# 4. Проверьте конфигурацию:
#    sudo nginx -t
#
# 5. Перезагрузите Nginx:
#    sudo systemctl reload nginx
#
# 6. Проверьте статус:
#    sudo systemctl status nginx
#
# ============================================
# ДЛЯ HTTPS (только для доменов):
# ============================================
# 1. Установите Certbot:
#    sudo apt install -y certbot python3-certbot-nginx
#
# 2. Получите SSL сертификат:
#    sudo certbot --nginx -d your-domain.com -d www.your-domain.com
#
# Certbot автоматически настроит HTTPS и редирект с HTTP на HTTPS
#
# ============================================
# ДЛЯ IP АДРЕСА С HTTPS:
# ============================================
# Certbot не работает с IP адресами. Используйте самоподписанный сертификат:
#
# 1. Создайте директорию:
#    sudo mkdir -p /etc/nginx/ssl
#
# 2. Создайте самоподписанный сертификат:
#    sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#        -keyout /etc/nginx/ssl/certificate.key \
#        -out /etc/nginx/ssl/certificate.crt
#
# 3. Раскомментируйте SSL настройки в конфигурации выше
